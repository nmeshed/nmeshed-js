{"version":3,"sources":["../../src/errors.ts","../../src/validation.ts","../../src/sync/binary.ts","../../src/client.ts","../../src/react/useNmeshed.tsx","../../src/react/context.tsx","../../src/react/useDocument.tsx","../../src/react/usePresence.tsx","../../src/react/useBroadcast.tsx","../../src/react/LiveCursors.tsx","../../src/react/AvatarStack.tsx"],"names":["z","listeners","useRef","useState","useEffect","useCallback","createContext","useContext","jsx","jsxs"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * Error types for nMeshed SDK.\n * \n * Using typed errors allows consumers to handle specific failure modes.\n */\n\n/**\n * Base class for all nMeshed errors.\n */\nexport class NMeshedError extends Error {\n    constructor(message: string, public readonly code: string) {\n        super(message);\n        this.name = 'NMeshedError';\n        // Maintains proper stack trace for where error was thrown (V8 only)\n        if (Error.captureStackTrace) {\n            Error.captureStackTrace(this, NMeshedError);\n        }\n    }\n}\n\n/**\n * Thrown when configuration is invalid.\n */\nexport class ConfigurationError extends NMeshedError {\n    constructor(message: string) {\n        super(message, 'CONFIGURATION_ERROR');\n        this.name = 'ConfigurationError';\n    }\n}\n\n/**\n * Thrown when connection fails or times out.\n */\nexport class ConnectionError extends NMeshedError {\n    constructor(\n        message: string,\n        public readonly cause?: Error,\n        public readonly isRetryable: boolean = true\n    ) {\n        super(message, 'CONNECTION_ERROR');\n        this.name = 'ConnectionError';\n    }\n}\n\n/**\n * Thrown when authentication fails.\n */\nexport class AuthenticationError extends NMeshedError {\n    constructor(message: string = 'Authentication failed') {\n        super(message, 'AUTHENTICATION_ERROR');\n        this.name = 'AuthenticationError';\n    }\n}\n\n/**\n * Thrown when a message fails to parse or validate.\n */\nexport class MessageError extends NMeshedError {\n    constructor(\n        message: string,\n        public readonly rawMessage?: string\n    ) {\n        super(message, 'MESSAGE_ERROR');\n        this.name = 'MessageError';\n    }\n}\n\n/**\n * Thrown when the operation queue exceeds capacity.\n */\nexport class QueueOverflowError extends NMeshedError {\n    constructor(maxSize: number) {\n        super(\n            `Operation queue exceeded maximum capacity of ${maxSize}. ` +\n            'Consider increasing maxQueueSize or reducing send frequency.',\n            'QUEUE_OVERFLOW_ERROR'\n        );\n        this.name = 'QueueOverflowError';\n    }\n}\n","import { z } from 'zod';\nimport { MessageError } from './errors';\nimport type { NMeshedMessage } from './types';\n\n/**\n * Zod schemas for message validation.\n * Enforcing \"Zod at the Gates\" to trust no one.\n */\n\nconst PresenceUserSchema = z.object({\n    userId: z.string(),\n    // We allow string to handle future status types without crashing, \n    // but we prefer the known union.\n    // We strictly enforce the union, but coerce unknown strings to 'offline'\n    // to prevent UI crashes (\"Happy Path\" resilience).\n    status: z.preprocess(\n        (val) => {\n            if (val === 'online' || val === 'idle' || val === 'offline') return val;\n            return 'offline';\n        },\n        z.union([\n            z.literal('online'),\n            z.literal('idle'),\n            z.literal('offline'),\n        ])\n    ),\n    last_seen: z.string().optional(),\n    metadata: z.record(z.unknown()).optional(),\n});\n\nconst OperationSchema = z.object({\n    key: z.string().min(1),\n    value: z.unknown(),\n    timestamp: z.number(),\n});\n\nconst InitMessageSchema = z.object({\n    type: z.literal('init'),\n    data: z.record(z.unknown()),\n});\n\nconst OperationMessageSchema = z.object({\n    type: z.literal('op'),\n    payload: OperationSchema,\n});\n\nconst PresenceMessageSchema = z.object({\n    type: z.literal('presence'),\n    users: z.array(PresenceUserSchema),\n});\n\n// Discriminated union for performance and type safety\nexport const MessageSchema = z.discriminatedUnion('type', [\n    InitMessageSchema,\n    OperationMessageSchema,\n    PresenceMessageSchema,\n]);\n\n/**\n * Parses and validates a raw message string from the server.\n * \n * @param raw - Raw JSON string from WebSocket\n * @returns Validated nMeshedMessage\n * @throws {MessageError} If message is invalid\n */\nexport function parseMessage(raw: string): NMeshedMessage {\n    let json: unknown;\n    try {\n        json = JSON.parse(raw);\n    } catch (error) {\n        throw new MessageError(\n            `Failed to parse message as JSON: ${error instanceof Error ? error.message : 'Unknown error'}`,\n            raw\n        );\n    }\n\n    const result = MessageSchema.safeParse(json);\n\n    if (!result.success) {\n        const errorMessages = result.error.issues\n            .map(e => `${e.path.join('.')}: ${e.message}`)\n            .join(', ');\n\n        throw new MessageError(\n            `Validation failed: ${errorMessages}`,\n            raw\n        );\n    }\n\n    return result.data as NMeshedMessage;\n}\n\n/**\n * Safely truncates a string for logging/error messages.\n */\nexport function truncate(str: string, maxLength: number = 200): string {\n    if (str.length <= maxLength) return str;\n    return str.substring(0, maxLength) + `... (${str.length - maxLength} more chars)`;\n}\n","/**\n * Binary Protocol Packer (v1)\n * Match spec in internal-docs/binary_spec.md\n */\n\nimport { Operation } from '../types';\n\nconst encoder = new TextEncoder();\nconst decoder = new TextDecoder();\n\n// Constants\nexport const MSG_TYPE_OP = 0x01;\nexport const MSG_TYPE_EPHEMERAL = 0x02;\nexport const MSG_TYPE_CURSOR = 0x03; // Legacy/Cursor specific\n\n/**\n * Encodes an Operation into the custom binary format.\n * Format:\n * [1 byte]  MsgType (0x01)\n * [16 bytes] WorkspaceUUID (Binary)\n * [1 byte]   Key Length (K)\n * [K bytes]  Key String (UTF-8)\n * [8 bytes]  Timestamp (int64, Unix Micro)\n * [4 bytes]  Value Length (V)\n * [V bytes]  Value (JSON/Bytes)\n */\nexport function marshalOp(workspaceId: string, op: Operation): ArrayBuffer {\n    const keyBytes = encoder.encode(op.key);\n\n    // Value handling: If it's already Uint8Array, use it. Else JSON stringify.\n    let valBytes: Uint8Array;\n    if (op.value instanceof Uint8Array) {\n        valBytes = op.value;\n    } else {\n        const jsonStr = JSON.stringify(op.value);\n        valBytes = encoder.encode(jsonStr);\n    }\n\n    // UUID Handling: Need to parse 36-char string to 16-byte array\n    const uuidBytes = parseUUID(workspaceId);\n\n    // Calculate Size\n    // 1 (Type) + 16 (UUID) + 4 (KeyLen) + KeyBytes + 8 (Timestamp) + 4 (ValLen) + ValBytes\n    const size = 1 + 16 + 4 + keyBytes.length + 8 + 4 + valBytes.length;\n    const buffer = new ArrayBuffer(size);\n    const view = new DataView(buffer);\n    const byteView = new Uint8Array(buffer);\n\n    let offset = 0;\n\n    // MsgType\n    view.setUint8(offset++, MSG_TYPE_OP);\n\n    // WorkspaceID (16 bytes)\n    byteView.set(uuidBytes, offset);\n    offset += 16;\n\n    // Key Length (4 bytes, Little Endian)\n    view.setUint32(offset, keyBytes.length, true);\n    offset += 4;\n\n    // Key\n    byteView.set(keyBytes, offset);\n    offset += keyBytes.length;\n\n    // Timestamp (8 bytes, Little Endian)\n    // Javascript numbers are doubles (53 bit integer precision).\n    // UnixMicro might exceed 53 bits (2^53 is ~9007 trillion, today is ~1.7 billion * 1e6 = 1.7e15. 2^53 is 9e15. Safe.)\n    // We can use BigInt for safety.\n    view.setBigInt64(offset, BigInt(op.timestamp), true);\n    offset += 8;\n\n    // Value Length (4 bytes, Little Endian)\n    view.setUint32(offset, valBytes.length, true);\n    offset += 4;\n\n    // Value\n    byteView.set(valBytes, offset);\n    offset += valBytes.length;\n\n    return buffer;\n}\n\n/**\n * Unmarshals a binary buffer into an Operation.\n * Returns the value as a raw Uint8Array. The caller is responsible for processing/parsing the value.\n */\nexport function unmarshalOp(buffer: ArrayBuffer): { workspaceId: string, op: Operation } | null {\n    const view = new DataView(buffer);\n    const byteView = new Uint8Array(buffer);\n    if (byteView.length < 1) return null;\n\n    let offset = 0;\n\n    const type = view.getUint8(offset++);\n    if (type !== MSG_TYPE_OP) return null;\n\n    // WorkspaceID\n    if (offset + 16 > byteView.length) return null;\n    const uuidBytes = byteView.subarray(offset, offset + 16);\n    const workspaceId = stringifyUUID(uuidBytes);\n    offset += 16;\n\n    // Key Length\n    if (offset + 4 > byteView.length) return null;\n    const keyLen = view.getUint32(offset, true);\n    offset += 4;\n\n    // Key\n    if (offset + keyLen > byteView.length) return null;\n    const keyBytes = byteView.subarray(offset, offset + keyLen);\n    const key = decoder.decode(keyBytes);\n    offset += keyLen;\n\n    // Timestamp\n    if (offset + 8 > byteView.length) return null;\n    const timestamp = Number(view.getBigInt64(offset, true));\n    offset += 8;\n\n    // Value Length\n    if (offset + 4 > byteView.length) return null;\n    const valLen = view.getUint32(offset, true);\n    offset += 4;\n\n    // Value\n    if (offset + valLen > byteView.length) return null;\n    // Copy the subarray to ensure data safety (avoid buffer reuse issues)\n    const valBytes = new Uint8Array(byteView.subarray(offset, offset + valLen));\n    offset += valLen;\n\n    return {\n        workspaceId,\n        op: {\n            key,\n            value: valBytes, // STRICT: Always return bytes\n            timestamp\n        }\n    };\n}\n\n\n// --- Legacy Cursor Helpers (Restored) ---\n\nexport function packCursor(userId: string, x: number, y: number): ArrayBuffer {\n    const userIdBytes = new TextEncoder().encode(userId);\n    // Op(1) + X(2) + Y(2) + ID_Len(1) + ID(N)\n    const buffer = new ArrayBuffer(1 + 2 + 2 + 1 + userIdBytes.length);\n    const view = new DataView(buffer);\n\n    let offset = 0;\n\n    view.setUint8(offset++, MSG_TYPE_CURSOR);\n\n    // Coordinates (Clamped to Uint16 range 0-65535)\n    view.setUint16(offset, Math.max(0, Math.min(65535, x)), false); // Big Endian\n    offset += 2;\n\n    view.setUint16(offset, Math.max(0, Math.min(65535, y)), false);\n    offset += 2;\n\n    view.setUint8(offset++, userIdBytes.length);\n    new Uint8Array(buffer).set(userIdBytes, offset);\n\n    return buffer;\n}\n\nexport function unpackCursor(buffer: ArrayBuffer): { x: number, y: number, userId: string } | null {\n    const view = new DataView(buffer);\n    if (view.byteLength < 6) return null;\n\n    let offset = 0;\n    const op = view.getUint8(offset++);\n\n    if (op !== MSG_TYPE_CURSOR) return null;\n\n    const x = view.getUint16(offset, false);\n    offset += 2;\n\n    const y = view.getUint16(offset, false);\n    offset += 2;\n\n    const idLen = view.getUint8(offset++);\n    const idBytes = new Uint8Array(buffer, offset, idLen);\n    const userId = new TextDecoder().decode(idBytes);\n\n    return { x, y, userId };\n}\n\nexport function isBinaryCursor(data: unknown): boolean {\n    if (!(data instanceof ArrayBuffer) && !(data instanceof Uint8Array)) return false;\n    // Check first byte\n    const view = new DataView(data instanceof Uint8Array ? data.buffer : data);\n    return view.byteLength > 0 && view.getUint8(0) === MSG_TYPE_CURSOR;\n}\n\n// Helpers\n\nfunction parseUUID(uuid: string): Uint8Array {\n    const hex = uuid.replace(/-/g, '');\n    const arr = new Uint8Array(16);\n    for (let i = 0; i < 16; i++) {\n        arr[i] = parseInt(hex.substr(i * 2, 2), 16);\n    }\n    return arr;\n}\n\nfunction stringifyUUID(bytes: Uint8Array): string {\n    const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');\n    return [\n        hex.substr(0, 8),\n        hex.substr(8, 4),\n        hex.substr(12, 4),\n        hex.substr(16, 4),\n        hex.substr(20, 12)\n    ].join('-');\n}\n","import type {\n    NMeshedConfig,\n    ConnectionStatus,\n    MessageHandler,\n    StatusHandler,\n    EphemeralHandler,\n    PresenceHandler,\n    ResolvedConfig,\n} from './types';\nimport {\n    ConfigurationError,\n    ConnectionError,\n} from './errors';\nimport { parseMessage, truncate } from './validation';\nimport { marshalOp, unmarshalOp } from './sync/binary';\nimport { z } from 'zod';\n\n/**\n * Configuration schema for validation.\n */\nconst ConfigSchema = z.object({\n    workspaceId: z.string().min(1, 'workspaceId is required and must be a non-empty string'),\n    token: z.string().min(1, 'token is required and must be a non-empty string'),\n    userId: z.string().optional(),\n    serverUrl: z.string().optional(),\n    autoReconnect: z.boolean().optional(),\n    maxReconnectAttempts: z.number().nonnegative().optional(),\n    reconnectBaseDelay: z.number().nonnegative().optional(),\n    maxReconnectDelay: z.number().nonnegative().optional(),\n    connectionTimeout: z.number().nonnegative().optional(),\n    heartbeatInterval: z.number().nonnegative().optional(),\n    maxQueueSize: z.number().nonnegative().optional(),\n    debug: z.boolean().optional(),\n});\n\n\n/**\n * Default configuration values.\n */\nconst DEFAULT_CONFIG: Omit<ResolvedConfig, 'workspaceId' | 'token' | 'userId'> = {\n    serverUrl: 'wss://api.nmeshed.com',\n    autoReconnect: true,\n    maxReconnectAttempts: 10,\n    reconnectBaseDelay: 1000,\n    maxReconnectDelay: 30000,\n    connectionTimeout: 10000,\n    heartbeatInterval: 30000,\n    maxQueueSize: 1000,\n    debug: false,\n};\n\n/**\n * Queued operation structure.\n */\ninterface QueuedOperation {\n    key: string;\n    value: unknown;\n    timestamp: number;\n}\n\n/**\n * nMeshed client for real-time synchronization.\n *\n * The client manages a WebSocket connection to an nMeshed server,\n * handles automatic reconnection, and provides methods for sending\n * and receiving state updates.\n *\n * ## Features\n * - Automatic reconnection with exponential backoff\n * - Connection timeout to prevent hangs\n * - Heartbeat pings to detect dead connections\n * - Operation queueing when offline\n * - Bounded queue to prevent memory issues\n * - Defensive message parsing\n *\n * @example Basic Usage\n * ```typescript\n * const client = new NMeshedClient({\n        *   workspaceId: 'my-workspace',\n        *   token: 'jwt-token'\n * });\n *\n * await client.connect();\n *\n * client.onMessage((msg) => {\n *   if (msg.type === 'op') {\n * console.log('Update:', msg.payload.key, '=', msg.payload.value);\n *   }\n * });\n *\n * client.set('greeting', 'Hello!');\n * ```\n */\nexport class NMeshedClient {\n    private readonly config: ResolvedConfig;\n    private ws: WebSocket | null = null;\n    private status: ConnectionStatus = 'IDLE';\n    private readonly messageListeners = new Set<MessageHandler>();\n    private readonly statusListeners = new Set<StatusHandler>();\n    private readonly ephemeralListeners = new Set<EphemeralHandler>();\n    private readonly presenceListeners = new Set<PresenceHandler>();\n    private reconnectAttempts = 0;\n    private reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\n    private connectionTimeout: ReturnType<typeof setTimeout> | null = null;\n    private heartbeatInterval: ReturnType<typeof setInterval> | null = null;\n    private operationQueue: QueuedOperation[] = [];\n    private currentState: Record<string, unknown> = {};\n    private isDestroyed = false;\n\n    /**\n     * Creates a new nMeshed client instance.\n     *\n     * @param config - Configuration options\n     * @throws {ConfigurationError} If workspaceId or token is missing\n     */\n    constructor(config: NMeshedConfig) {\n        // Zod at the Gates: Trust no one.\n        const result = ConfigSchema.safeParse(config);\n\n        if (!result.success) {\n            // Fail Loudly\n            const errorMessages = result.error.issues\n                .map(e => `${e.path.join('.')}: ${e.message}`)\n                .join(', ');\n            throw new ConfigurationError(`nMeshed: ${errorMessages}`);\n        }\n\n        const validConfig = result.data;\n\n        this.config = {\n            ...DEFAULT_CONFIG,\n            workspaceId: validConfig.workspaceId.trim(),\n            token: validConfig.token,\n            userId: validConfig.userId?.trim() || this.generateUserId(),\n            ...(validConfig.serverUrl && { serverUrl: validConfig.serverUrl }),\n            ...(validConfig.autoReconnect !== undefined && { autoReconnect: validConfig.autoReconnect }),\n            ...(validConfig.maxReconnectAttempts !== undefined && { maxReconnectAttempts: validConfig.maxReconnectAttempts }),\n            ...(validConfig.reconnectBaseDelay !== undefined && { reconnectBaseDelay: validConfig.reconnectBaseDelay }),\n            ...(validConfig.maxReconnectDelay !== undefined && { maxReconnectDelay: validConfig.maxReconnectDelay }),\n            ...(validConfig.connectionTimeout !== undefined && { connectionTimeout: validConfig.connectionTimeout }),\n            ...(validConfig.heartbeatInterval !== undefined && { heartbeatInterval: validConfig.heartbeatInterval }),\n            ...(validConfig.maxQueueSize !== undefined && { maxQueueSize: validConfig.maxQueueSize }),\n            ...(validConfig.debug !== undefined && { debug: validConfig.debug }),\n        } as ResolvedConfig; // Cast is safe because we merged defaults\n    }\n\n    /**\n     * Generates a random user ID using crypto if available, falling back to Math.random.\n     */\n    private generateUserId(): string {\n        // Try crypto API first (more random)\n        if (typeof crypto !== 'undefined' && crypto.randomUUID) {\n            return `user-${crypto.randomUUID().substring(0, 8)}`;\n        }\n        // Fallback to Math.random\n        return 'user-' + Math.random().toString(36).substring(2, 11);\n    }\n\n    /**\n     * Logs a debug message if debug mode is enabled.\n     */\n    private log(message: string, ...args: unknown[]): void {\n        if (this.config.debug) {\n            const timestamp = new Date().toISOString();\n            console.log(`[nMeshed ${timestamp}] ${message} `, ...args);\n        }\n    }\n\n    /**\n     * Logs a warning message (always shown).\n     */\n    private warn(message: string, ...args: unknown[]): void {\n        console.warn(`[nMeshed] ${message} `, ...args);\n    }\n\n    /**\n     * Updates the connection status and notifies listeners.\n     */\n    private setStatus(newStatus: ConnectionStatus): void {\n        if (this.status !== newStatus) {\n            this.log(`Status: ${this.status} -> ${newStatus} `);\n            this.status = newStatus;\n\n            // Clone listeners to avoid mutation during iteration\n            const listeners = Array.from(this.statusListeners);\n            for (const listener of listeners) {\n                try {\n                    listener(newStatus);\n                } catch (error) {\n                    this.warn('Status listener threw an error:', error);\n                }\n            }\n        }\n    }\n\n    /**\n     * Builds the WebSocket URL with query parameters.\n     */\n    private buildUrl(): string {\n        const base = this.config.serverUrl.replace(/\\/+$/, '');\n        const params = new URLSearchParams({\n            token: this.config.token,\n            userId: this.config.userId,\n        });\n        // Encode workspaceId to handle special characters\n        const encodedWorkspace = encodeURIComponent(this.config.workspaceId);\n        return `${base}/v1/sync/${encodedWorkspace}?${params.toString()}`;\n    }\n\n    /**\n     * Connects to the nMeshed server.\n     *\n     * @returns A promise that resolves when connected, or rejects on error.\n     * @throws {ConnectionError} If connection fails or times out\n     */\n    connect(): Promise<void> {\n        if (this.isDestroyed) {\n            return Promise.reject(new ConnectionError('Client has been destroyed', undefined, false));\n        }\n\n        if (this.status === 'CONNECTED') {\n            this.log('Already connected');\n            return Promise.resolve();\n        }\n\n        if (this.status === 'CONNECTING') {\n            this.log('Connection already in progress');\n            return Promise.resolve();\n        }\n\n        return new Promise((resolve, reject) => {\n            this.setStatus('CONNECTING');\n            const url = this.buildUrl();\n            this.log('Connecting to', url.replace(this.config.token, '[REDACTED]'));\n\n            // Set connection timeout\n            if (this.config.connectionTimeout > 0) {\n                this.connectionTimeout = setTimeout(() => {\n                    this.log('Connection timeout');\n                    this.cleanupConnection();\n                    this.setStatus('ERROR');\n                    reject(new ConnectionError(\n                        `Connection timed out after ${this.config.connectionTimeout} ms`,\n                        undefined,\n                        true\n                    ));\n                }, this.config.connectionTimeout);\n            }\n\n            try {\n                this.ws = new WebSocket(url);\n            } catch (error) {\n                this.clearConnectionTimeout();\n                this.setStatus('ERROR');\n                reject(new ConnectionError(\n                    'Failed to create WebSocket',\n                    error instanceof Error ? error : undefined,\n                    false\n                ));\n                return;\n            }\n\n            this.ws.onopen = () => {\n                this.clearConnectionTimeout();\n                this.log('WebSocket connected');\n                this.setStatus('CONNECTED');\n                this.reconnectAttempts = 0;\n                this.startHeartbeat();\n                this.flushOperationQueue();\n                resolve();\n            };\n\n            this.ws.onclose = (event) => {\n                this.clearConnectionTimeout();\n                this.log('WebSocket closed', { code: event.code, reason: event.reason });\n                this.handleDisconnect(event.code);\n            };\n\n            this.ws.onerror = () => {\n                this.log('WebSocket error');\n                if (this.status === 'CONNECTING') {\n                    this.clearConnectionTimeout();\n                    this.setStatus('ERROR');\n                    reject(new ConnectionError('WebSocket connection failed', undefined, true));\n                }\n            };\n\n            this.ws.binaryType = 'arraybuffer'; // Crucial for performance\n\n            this.ws.onmessage = (event) => {\n                if (event.data instanceof ArrayBuffer) {\n                    // Binary Path (Fast Lane)\n                    // Check if it's a known binary Op or just ephemeral\n                    const op = unmarshalOp(event.data);\n                    if (op) {\n                        this.log('Received Binary Op:', op.op.key);\n\n                        // DECODE VALUE (Application Layer)\n                        // Binary protocol blindly returns bytes. We assume JSON for compatibility.\n                        // Ideally, the protocol would have a type flag.\n                        let decodedValue: unknown = op.op.value;\n                        if (op.op.value instanceof Uint8Array) {\n                            try {\n                                const str = new TextDecoder().decode(op.op.value);\n                                decodedValue = JSON.parse(str);\n                            } catch {\n                                // Keep as bytes if not JSON\n                                decodedValue = op.op.value;\n                            }\n                        }\n\n                        // Update local state\n                        this.currentState[op.op.key] = decodedValue;\n\n                        // Notify listeners as if it was a standard Op message\n                        const message: any = {\n                            type: 'op',\n                            payload: {\n                                ...op.op,\n                                value: decodedValue\n                            }\n                        };\n\n                        const listeners = Array.from(this.messageListeners);\n                        for (const listener of listeners) {\n                            try {\n                                listener(message);\n                            } catch (error) {\n                                this.warn('Message listener threw an error:', error);\n                            }\n                        }\n                        return;\n                    }\n\n                    // If not an Op, assume Ephemeral/Cursor (Legacy or Spec v2)\n                    const listeners = Array.from(this.ephemeralListeners);\n                    for (const listener of listeners) {\n                        try {\n                            listener(event.data);\n                        } catch (error) {\n                            this.warn('Binary listener threw error:', error);\n                        }\n                    }\n                } else {\n                    // Slow Path: Text/JSON\n                    this.handleMessage(event.data);\n                }\n            };\n        });\n    }\n\n    /**\n     * Clears the connection timeout timer.\n     */\n    private clearConnectionTimeout(): void {\n        if (this.connectionTimeout) {\n            clearTimeout(this.connectionTimeout);\n            this.connectionTimeout = null;\n        }\n    }\n\n    /**\n     * Starts the heartbeat interval to detect dead connections.\n     */\n    private startHeartbeat(): void {\n        this.stopHeartbeat();\n\n        if (this.config.heartbeatInterval <= 0) {\n            return;\n        }\n\n        this.heartbeatInterval = setInterval(() => {\n            if (this.ws?.readyState === WebSocket.OPEN) {\n                try {\n                    // Send a ping message\n                    // Note: Browser WebSocket doesn't expose ping(), so we send a custom message\n                    this.ws.send(JSON.stringify({ type: 'ping', timestamp: Date.now() }));\n                    this.log('Heartbeat sent');\n                } catch (error) {\n                    this.warn('Failed to send heartbeat:', error);\n                }\n            }\n        }, this.config.heartbeatInterval);\n    }\n\n    /**\n     * Stops the heartbeat interval.\n     */\n    private stopHeartbeat(): void {\n        if (this.heartbeatInterval) {\n            clearInterval(this.heartbeatInterval);\n            this.heartbeatInterval = null;\n        }\n    }\n\n    /**\n     * Handles incoming messages from the server.\n     */\n    private handleMessage(data: string): void {\n        try {\n            const message = parseMessage(data);\n            this.log('Received:', message.type);\n\n            // Update local state cache\n            if (message.type === 'init') {\n                this.currentState = { ...message.data };\n            } else if (message.type === 'op') {\n                this.currentState[message.payload.key] = message.payload.value;\n            } else if (message.type === 'ephemeral') {\n                // Dispatch to ephemeral listeners\n                const listeners = Array.from(this.ephemeralListeners);\n                for (const listener of listeners) {\n                    try {\n                        listener(message.payload);\n                    } catch (error) {\n                        this.warn('Ephemeral listener threw an error:', error);\n                    }\n                }\n            } else if (message.type === 'presence') {\n                // Dispatch to presence listeners\n                const listeners = Array.from(this.presenceListeners);\n                for (const listener of listeners) {\n                    try {\n                        listener(message.payload);\n                    } catch (error) {\n                        this.warn('Presence listener threw an error:', error);\n                    }\n                }\n            }\n            // Ignore pong messages (heartbeat responses)\n\n            // Notify generic listeners\n            const listeners = Array.from(this.messageListeners);\n            for (const listener of listeners) {\n                try {\n                    listener(message);\n                } catch (error) {\n                    this.warn('Message listener threw an error:', error);\n                }\n            }\n        } catch (error) {\n            // Log but don't crash on malformed messages\n            this.warn('Failed to parse message:', truncate(data), error);\n        }\n    }\n\n    /**\n     * Handles disconnection and initiates reconnection if configured.\n     */\n    private handleDisconnect(closeCode?: number): void {\n        this.cleanupConnection();\n\n        // Check for authentication errors (typically 4001 or 4003)\n        if (closeCode && closeCode >= 4000 && closeCode < 4100) {\n            this.warn('Authentication error, not reconnecting');\n            this.setStatus('ERROR');\n            return;\n        }\n\n        if (!this.config.autoReconnect) {\n            this.setStatus('DISCONNECTED');\n            return;\n        }\n\n        if (this.reconnectAttempts >= this.config.maxReconnectAttempts) {\n            this.log('Max reconnect attempts reached');\n            this.setStatus('ERROR');\n            return;\n        }\n\n        this.setStatus('RECONNECTING');\n        this.scheduleReconnect();\n    }\n\n    /**\n     * Cleans up the current connection without changing status.\n     */\n    private cleanupConnection(): void {\n        this.stopHeartbeat();\n        this.clearConnectionTimeout();\n\n        if (this.ws) {\n            // Remove handlers to prevent callbacks during cleanup\n            this.ws.onopen = null;\n            this.ws.onclose = null;\n            this.ws.onerror = null;\n            this.ws.onmessage = null;\n\n            try {\n                this.ws.close();\n            } catch {\n                // Ignore errors during cleanup\n            }\n            this.ws = null;\n        }\n    }\n\n    /**\n     * Schedules a reconnection attempt with capped exponential backoff.\n     */\n    private scheduleReconnect(): void {\n        // Calculate delay with exponential backoff, capped at maxReconnectDelay\n        const rawDelay = this.config.reconnectBaseDelay * Math.pow(2, this.reconnectAttempts);\n        const delay = Math.min(rawDelay, this.config.maxReconnectDelay);\n\n        // Add jitter (10%) to prevent thundering herd\n        const jitter = delay * 0.1 * (Math.random() * 2 - 1);\n        const finalDelay = Math.round(delay + jitter);\n\n        this.log(`Reconnecting in ${finalDelay} ms(attempt ${this.reconnectAttempts + 1} / ${this.config.maxReconnectAttempts})`);\n\n        this.reconnectTimeout = setTimeout(() => {\n            this.reconnectAttempts++;\n            this.connect().catch((error) => {\n                this.log('Reconnect failed:', error);\n                // handleDisconnect will be called by the WebSocket close event\n            });\n        }, finalDelay);\n    }\n\n    /**\n     * Flushes any operations queued while disconnected.\n     */\n    private flushOperationQueue(): void {\n        if (this.operationQueue.length === 0) {\n            return;\n        }\n\n        this.log(`Flushing ${this.operationQueue.length} queued operations`);\n\n        // Process a snapshot of the queue to prevent infinite loops if operations are re-queued\n        const queueToProcess = [...this.operationQueue];\n        this.operationQueue = [];\n\n        for (const op of queueToProcess) {\n            this.sendOperationInternal(op.key, op.value, op.timestamp);\n        }\n    }\n\n    /**\n     * Sets a key-value pair in the workspace.\n     *\n     * @param key - The key to set (must be non-empty string)\n     * @param value - The value to set\n     * @throws {ConfigurationError} If key is invalid\n     */\n    set(key: string, value: unknown): void {\n        if (!key || typeof key !== 'string') {\n            throw new ConfigurationError('Key must be a non-empty string');\n        }\n        this.sendOperation(key, value);\n    }\n\n    /**\n     * Gets the current value of a key from local state.\n     *\n     * Note: This returns the locally cached state, which may be\n     * momentarily out of sync with the server.\n     *\n     * @param key - The key to get\n     * @returns The value, or undefined if not found\n     */\n    get<T = unknown>(key: string): T | undefined {\n        return this.currentState[key] as T | undefined;\n    }\n\n    /**\n     * Gets the entire current state of the workspace.\n     *\n     * @returns A shallow copy of the current state\n     */\n    getState(): Record<string, unknown> {\n        return { ...this.currentState };\n    }\n\n    /**\n     * Sends an operation to update a key-value pair.\n     *\n     * If not connected, the operation is queued and sent when reconnected.\n     *\n     * @param key - The key to update\n     * @param value - The new value\n     */\n    sendOperation(key: string, value: unknown): void {\n        const timestamp = Date.now() * 1000; // Unix microseconds\n\n        // Optimistic local update\n        this.currentState[key] = value;\n\n        if (this.ws?.readyState !== WebSocket.OPEN) {\n            this.queueOperation(key, value, timestamp);\n            return;\n        }\n\n        this.sendOperationInternal(key, value, timestamp);\n    }\n\n    /**\n     * Broadcasts an ephemeral message to all other connected clients.\n     * \n     * @param payload - The data to broadcast (JSON object or Binary ArrayBuffer)\n     */\n    broadcast(payload: unknown): void {\n        if (this.ws?.readyState !== WebSocket.OPEN) {\n            this.warn('Cannot broadcast: not connected');\n            return;\n        }\n\n        try {\n            // Binary Path (Fast Lane)\n            if (payload instanceof ArrayBuffer || payload instanceof Uint8Array) {\n                this.ws.send(payload);\n                return;\n            }\n\n            // JSON Path (Slow Lane)\n            const message = JSON.stringify({\n                type: 'ephemeral',\n                payload\n            });\n            this.ws.send(message);\n        } catch (error) {\n            this.warn('Failed to broadcast message:', error);\n        }\n    }\n\n    /**\n     * Internal method to send an operation (assumes connection is open).\n     */\n    private sendOperationInternal(key: string, value: unknown, timestamp: number): void {\n        if (this.ws?.readyState !== WebSocket.OPEN) {\n            this.queueOperation(key, value, timestamp);\n            return;\n        }\n\n        // Binary Path: ALWAYS prefer binary for Ops if possible\n        try {\n            const binaryOp = marshalOp(this.config.workspaceId, { key, value, timestamp });\n            this.ws.send(binaryOp);\n            this.log('Sent binary operation:', key);\n        } catch (error) {\n            this.warn('Failed to send binary operation, falling back to JSON:', error);\n\n            // Fallback to JSON if binary fails (shouldn't happen unless value is circular etc)\n            try {\n                const message = JSON.stringify({\n                    type: 'op',\n                    payload: { key, value, timestamp },\n                });\n                this.ws.send(message);\n                this.log('Sent JSON operation:', key);\n            } catch (jsonError) {\n                this.warn('Failed to send JSON operation:', jsonError);\n                this.queueOperation(key, value, timestamp);\n            }\n        }\n    }\n\n    /**\n     * Queues an operation for later sending.\n     */\n    private queueOperation(key: string, value: unknown, timestamp: number): void {\n        // Check queue size limit\n        if (this.config.maxQueueSize > 0 && this.operationQueue.length >= this.config.maxQueueSize) {\n            // Drop oldest operation (FIFO)\n            const dropped = this.operationQueue.shift();\n            this.warn(`Queue full, dropping oldest operation: ${dropped?.key} `);\n        }\n\n        this.operationQueue.push({ key, value, timestamp });\n        this.log(`Queued operation: ${key} (queue size: ${this.operationQueue.length})`);\n    }\n\n    /**\n     * Subscribes to incoming messages.\n     *\n     * @param handler - Function to call when a message is received\n     * @returns A cleanup function to unsubscribe\n     */\n    onMessage(handler: MessageHandler): () => void {\n        if (typeof handler !== 'function') {\n            throw new ConfigurationError('Message handler must be a function');\n        }\n\n        this.messageListeners.add(handler);\n        return () => {\n            this.messageListeners.delete(handler);\n        };\n    }\n\n    /**\n     * Subscribes to connection status changes.\n     *\n     * The handler is called immediately with the current status.\n     *\n     * @param handler - Function to call when status changes\n     * @returns A cleanup function to unsubscribe\n     */\n    /**\n     * Subscribes to ephemeral broadcasts.\n     */\n    onBroadcast(handler: EphemeralHandler): () => void {\n        if (typeof handler !== 'function') {\n            throw new ConfigurationError('Broadcast handler must be a function');\n        }\n        this.ephemeralListeners.add(handler);\n        return () => {\n            this.ephemeralListeners.delete(handler);\n        };\n    }\n\n    /**\n     * Subscribes to presence updates.\n     */\n    onPresence(handler: PresenceHandler): () => void {\n        if (typeof handler !== 'function') {\n            throw new ConfigurationError('Presence handler must be a function');\n        }\n        this.presenceListeners.add(handler);\n        return () => {\n            this.presenceListeners.delete(handler);\n        };\n    }\n\n    onStatusChange(handler: StatusHandler): () => void {\n        if (typeof handler !== 'function') {\n            throw new ConfigurationError('Status handler must be a function');\n        }\n\n        this.statusListeners.add(handler);\n        // Immediately call with current status\n        try {\n            handler(this.status);\n        } catch (error) {\n            this.warn('Status handler threw an error:', error);\n        }\n        return () => {\n            this.statusListeners.delete(handler);\n        };\n    }\n\n    /**\n     * Gets the current connection status.\n     */\n    getStatus(): ConnectionStatus {\n        return this.status;\n    }\n\n    /**\n     * Gets the number of operations in the queue.\n     */\n    getQueueSize(): number {\n        return this.operationQueue.length;\n    }\n\n    /**\n     * Disconnects from the server.\n     *\n     * After calling this, you can call `connect()` again to reconnect.\n     */\n    disconnect(): void {\n        this.log('Disconnecting');\n\n        // Cancel any pending reconnection\n        if (this.reconnectTimeout) {\n            clearTimeout(this.reconnectTimeout);\n            this.reconnectTimeout = null;\n        }\n\n        this.cleanupConnection();\n        this.setStatus('DISCONNECTED');\n    }\n\n    /**\n     * Alias for disconnect() for API consistency.\n     */\n    close(): void {\n        this.disconnect();\n    }\n\n    /**\n     * Helper to convert WebSocket URL to HTTP URL.\n     */\n    private getHttpUrl(path: string): string {\n        try {\n            const url = new URL(this.config.serverUrl);\n            url.protocol = url.protocol === 'wss:' ? 'https:' : 'http:';\n            const base = url.toString().replace(/\\/+$/, '');\n            return `${base}${path}`;\n        } catch (e) {\n            // Fallback if URL parsing fails\n            const base = this.config.serverUrl\n                .replace(/^wss:\\/\\//, 'https://')\n                .replace(/^ws:\\/\\//, 'http://')\n                .replace(/\\/+$/, '');\n            return `${base}${path}`;\n        }\n    }\n\n    /**\n     * Fetches current presence information for the workspace.\n     * \n     * @returns A promise resolving to a list of active users.\n     */\n    // Updated to match PresenceUser type in types.ts (with optional last_seen)\n    async getPresence(): Promise<Array<{ userId: string; status: 'online' | 'idle' | 'offline'; last_seen?: string; metadata?: Record<string, unknown> }>> {\n        const url = this.getHttpUrl(`/v1/presence/${this.config.workspaceId}`);\n\n        const response = await fetch(url, {\n            headers: {\n                'Authorization': `Bearer ${this.config.token}`\n            }\n        });\n\n        if (!response.ok) {\n            throw new Error(`Failed to fetch presence: ${response.statusText}`);\n        }\n\n        return response.json();\n    }\n\n    /**\n     * Permanently destroys the client, releasing all resources.\n     * \n     * After calling this, the client cannot be reconnected.\n     * Use this for cleanup in React useEffect or similar.\n     */\n    destroy(): void {\n        this.log('Destroying client');\n        this.disconnect();\n        this.messageListeners.clear();\n        this.statusListeners.clear();\n        this.ephemeralListeners.clear();\n        this.presenceListeners.clear();\n        this.operationQueue = [];\n        this.currentState = {};\n        this.isDestroyed = true;\n    }\n}\n","import { useState, useEffect, useRef, useCallback } from 'react';\nimport { NMeshedClient } from '../client';\nimport type { NMeshedConfig, ConnectionStatus, NMeshedMessage } from '../types';\n\n/**\n * Options for the useNmeshed hook.\n */\nexport interface UseNmeshedOptions extends NMeshedConfig {\n    /**\n     * Callback when connected.\n     */\n    onConnect?: () => void;\n\n    /**\n     * Callback when disconnected.\n     */\n    onDisconnect?: () => void;\n\n    /**\n     * Callback when an error occurs.\n     */\n    onError?: (error: Error) => void;\n}\n\n/**\n * Return value of the useNmeshed hook.\n */\nexport interface UseNmeshedReturn {\n    /**\n     * Current state of the workspace as a reactive object.\n     */\n    state: Record<string, unknown>;\n\n    /**\n     * Set a value in the workspace.\n     */\n    set: (key: string, value: unknown) => void;\n\n    /**\n     * Get a value from the workspace.\n     */\n    get: <T = unknown>(key: string) => T | undefined;\n\n    /**\n     * Current connection status.\n     */\n    status: ConnectionStatus;\n\n    /**\n     * Whether the client is connected.\n     */\n    isConnected: boolean;\n\n    /**\n     * The underlying nMeshed client instance.\n     */\n    client: NMeshedClient;\n\n    /**\n     * Manually connect to the server.\n     */\n    connect: () => Promise<void>;\n\n    /**\n     * Manually disconnect from the server.\n     */\n    disconnect: () => void;\n}\n\n/**\n * React hook for real-time synchronization with nMeshed.\n * \n * This hook creates and manages an nMeshed client, provides reactive\n * state, and handles connection lifecycle automatically.\n * \n * @param options - Configuration and callbacks\n * @returns Object with state, setters, and connection status\n * \n * @example Basic Usage\n * ```tsx\n * function CollaborativeEditor() {\n *   const { state, set, status } = useNmeshed({\n *     workspaceId: 'my-doc',\n *     token: 'jwt-token'\n *   });\n *   \n *   return (\n *     <div>\n *       <p>Status: {status}</p>\n *       <textarea\n *         value={state.content as string || ''}\n *         onChange={(e) => set('content', e.target.value)}\n *       />\n *     </div>\n *   );\n * }\n * ```\n * \n * @example With Callbacks\n * ```tsx\n * const { state, set } = useNmeshed({\n *   workspaceId: 'my-doc',\n *   token: 'jwt-token',\n *   onConnect: () => console.log('Connected!'),\n *   onDisconnect: () => console.log('Disconnected'),\n *   onError: (err) => console.error('Error:', err)\n * });\n * ```\n */\nexport function useNmeshed(options: UseNmeshedOptions): UseNmeshedReturn {\n    const { onConnect, onDisconnect, onError, ...config } = options;\n\n    // Create client once\n    const clientRef = useRef<NMeshedClient | null>(null);\n    if (!clientRef.current) {\n        clientRef.current = new NMeshedClient(config);\n    }\n    const client = clientRef.current;\n\n    // Reactive state\n    const [state, setState] = useState<Record<string, unknown>>({});\n    const [status, setStatus] = useState<ConnectionStatus>('IDLE');\n\n    // Connect on mount\n    useEffect(() => {\n        const currentClient = client;\n\n        // Subscribe to status changes\n        const unsubscribeStatus = currentClient.onStatusChange((newStatus) => {\n            setStatus(newStatus);\n\n            if (newStatus === 'CONNECTED') {\n                onConnect?.();\n            } else if (newStatus === 'DISCONNECTED') {\n                onDisconnect?.();\n            } else if (newStatus === 'ERROR') {\n                onError?.(new Error('Connection error'));\n            }\n        });\n\n        // Subscribe to messages\n        const unsubscribeMessage = currentClient.onMessage((message: NMeshedMessage) => {\n            if (message.type === 'init') {\n                setState(message.data);\n            } else if (message.type === 'op') {\n                setState((prev) => ({\n                    ...prev,\n                    [message.payload.key]: message.payload.value,\n                }));\n            }\n        });\n\n        // Connect\n        currentClient.connect().catch((error) => {\n            onError?.(error);\n        });\n\n        // Cleanup\n        return () => {\n            unsubscribeStatus();\n            unsubscribeMessage();\n            currentClient.disconnect();\n        };\n        // eslint-disable-next-line react-hooks/exhaustive-deps\n    }, []); // Only run on mount\n\n    // Memoized setters\n    const set = useCallback((key: string, value: unknown) => {\n        client.set(key, value);\n        // Optimistic update\n        setState((prev) => ({ ...prev, [key]: value }));\n    }, [client]);\n\n    const get = useCallback(<T = unknown>(key: string): T | undefined => {\n        return state[key] as T | undefined;\n    }, [state]);\n\n    const connect = useCallback(() => client.connect(), [client]);\n    const disconnect = useCallback(() => client.disconnect(), [client]);\n\n    return {\n        state,\n        set,\n        get,\n        status,\n        isConnected: status === 'CONNECTED',\n        client,\n        connect,\n        disconnect,\n    };\n}\n","import { createContext, useContext, useRef, useEffect, type ReactNode } from 'react';\nimport { NMeshedClient } from '../client';\nimport type { NMeshedConfig } from '../types';\n\n/**\n * Context for sharing an nMeshed client across components.\n */\nconst NMeshedContext = createContext<NMeshedClient | null>(null);\n\n/**\n * Props for NMeshedProvider.\n */\nexport interface NMeshedProviderProps {\n    /**\n     * Configuration for the nMeshed client.\n     */\n    config: NMeshedConfig;\n\n    /**\n     * Child components that will have access to the client.\n     */\n    children: ReactNode;\n\n    /**\n     * Whether to automatically connect on mount.\n     * @default true\n     */\n    autoConnect?: boolean;\n}\n\n/**\n * Provider component that creates and manages an nMeshed client.\n * \n * Wrap your app (or a portion of it) with this provider to share\n * a single client instance across multiple components.\n * \n * @example\n * ```tsx\n * import { NMeshedProvider } from 'nmeshed/react';\n * \n * function App() {\n *   return (\n *     <NMeshedProvider\n *       config={{\n *         workspaceId: 'my-workspace',\n *         token: 'jwt-token'\n *       }}\n *     >\n *       <MyCollaborativeApp />\n *     </NMeshedProvider>\n *   );\n * }\n * ```\n */\nexport function NMeshedProvider({\n    config,\n    children,\n    autoConnect = true,\n}: NMeshedProviderProps) {\n    const clientRef = useRef<NMeshedClient | null>(null);\n\n    // Create client on first render\n    if (!clientRef.current) {\n        clientRef.current = new NMeshedClient(config);\n    }\n\n    useEffect(() => {\n        const client = clientRef.current;\n        if (!client) return;\n\n        if (autoConnect) {\n            client.connect().catch((error) => {\n                console.error('[nMeshed] Auto-connect failed:', error);\n            });\n        }\n\n        return () => {\n            client.disconnect();\n        };\n    }, [autoConnect]);\n\n    return (\n        <NMeshedContext.Provider value={clientRef.current}>\n            {children}\n        </NMeshedContext.Provider>\n    );\n}\n\n/**\n * Hook to access the nMeshed client from context.\n * \n * Must be used within an NMeshedProvider.\n * \n * @returns The nMeshed client instance\n * @throws {Error} If used outside of NMeshedProvider\n * \n * @example\n * ```tsx\n * function MyComponent() {\n *   const client = useNmeshedContext();\n *   \n *   const handleClick = () => {\n *     client.set('clicked', true);\n *   };\n *   \n *   return <button onClick={handleClick}>Click me</button>;\n * }\n * ```\n */\nexport function useNmeshedContext(): NMeshedClient {\n    const client = useContext(NMeshedContext);\n\n    if (!client) {\n        throw new Error(\n            'useNmeshedContext must be used within an NMeshedProvider. ' +\n            'Wrap your component tree with <NMeshedProvider>.'\n        );\n    }\n\n    return client;\n}\n","import { useState, useEffect, useCallback } from 'react';\nimport { useNmeshedContext } from './context';\nimport type { NMeshedMessage } from '../types';\n\n/**\n * Options for the useDocument hook.\n */\nexport interface UseDocumentOptions<T> {\n    /**\n     * The key to sync.\n     */\n    key: string;\n\n    /**\n     * Initial value before server state is received.\n     */\n    initialValue?: T;\n}\n\n/**\n * Return value of the useDocument hook.\n */\nexport interface UseDocumentReturn<T> {\n    /**\n     * Current value of the document.\n     */\n    value: T | undefined;\n\n    /**\n     * Update the value.\n     */\n    setValue: (newValue: T) => void;\n\n    /**\n     * Whether the value has been loaded from the server.\n     */\n    isLoaded: boolean;\n}\n\n/**\n * Hook to sync a single key with nMeshed.\n * \n * Provides a simple useState-like interface for a single synchronized value.\n * Must be used within an nMeshedProvider.\n * \n * @param options - Configuration options\n * @returns Object with value, setter, and loading state\n * \n * @example\n * ```tsx\n * function Counter() {\n *   const { value, setValue, isLoaded } = useDocument<number>({\n *     key: 'counter',\n *     initialValue: 0\n *   });\n *   \n *   if (!isLoaded) return <div>Loading...</div>;\n *   \n *   return (\n *     <div>\n *       <p>Count: {value}</p>\n *       <button onClick={() => setValue((value || 0) + 1)}>\n *         Increment\n *       </button>\n *     </div>\n *   );\n * }\n * ```\n * \n * @example With Complex Objects\n * ```tsx\n * interface Todo {\n *   id: string;\n *   text: string;\n *   done: boolean;\n * }\n * \n * function TodoItem({ id }: { id: string }) {\n *   const { value, setValue } = useDocument<Todo>({\n *     key: `todo:${id}`\n *   });\n *   \n *   if (!value) return null;\n *   \n *   return (\n *     <div>\n *       <input\n *         type=\"checkbox\"\n *         checked={value.done}\n *         onChange={() => setValue({ ...value, done: !value.done })}\n *       />\n *       <span>{value.text}</span>\n *     </div>\n *   );\n * }\n * ```\n */\nexport function useDocument<T = unknown>(\n    options: UseDocumentOptions<T>\n): UseDocumentReturn<T> {\n    const { key, initialValue } = options;\n    const client = useNmeshedContext();\n\n    const [value, setLocalValue] = useState<T | undefined>(initialValue);\n    const [isLoaded, setIsLoaded] = useState(false);\n\n    useEffect(() => {\n        // Check if value already exists in client state\n        const existing = client.get<T>(key);\n        if (existing !== undefined) {\n            setLocalValue(existing);\n            setIsLoaded(true);\n        }\n\n        // Subscribe to updates\n        const unsubscribe = client.onMessage((message: NMeshedMessage) => {\n            if (message.type === 'init' && key in message.data) {\n                setLocalValue(message.data[key] as T);\n                setIsLoaded(true);\n            } else if (message.type === 'op' && message.payload.key === key) {\n                setLocalValue(message.payload.value as T);\n                setIsLoaded(true);\n            }\n        });\n\n        return unsubscribe;\n    }, [client, key]);\n\n    const setValue = useCallback((newValue: T) => {\n        client.set(key, newValue);\n        setLocalValue(newValue); // Optimistic update\n    }, [client, key]);\n\n    return {\n        value,\n        setValue,\n        isLoaded,\n    };\n}\n","import { useState, useEffect } from 'react';\nimport { useNmeshedContext } from './context';\nimport type { PresenceUser } from '../types';\n\nexport type UsePresenceOptions = {\n    /**\n     * @deprecated Polling is no longer needed; presence is real-time.\n     */\n    interval?: number;\n};\n\n/**\n * Hook to get the current presence list for the workspace.\n * Uses real-time WebSocket events.\n * \n * @param options - Configuration options\n * @returns Array of active users\n */\nexport function usePresence(options: UsePresenceOptions = {}): PresenceUser[] {\n    void options; // Silence unused warning (deprecated)\n    const client = useNmeshedContext();\n    const [users, setUsers] = useState<PresenceUser[]>([]);\n\n    useEffect(() => {\n        let mounted = true;\n\n        // 1. Initial Fetch (HTTP)\n        const fetchInitial = async () => {\n            if (client.getStatus() === 'CONNECTED') {\n                try {\n                    const initialUsers = await client.getPresence();\n                    if (mounted) {\n                        setUsers(initialUsers);\n                    }\n                } catch (e) {\n                    console.warn('Failed to fetch initial presence:', e);\n                }\n            }\n        };\n\n        fetchInitial();\n\n        // 2. Subscribe to Real-time Updates (WS)\n        const unsubscribe = client.onPresence((eventPayload) => {\n            setUsers((current) => {\n                // If offline, remove from list\n                if (eventPayload.status === 'offline') {\n                    return current.filter(u => u.userId !== eventPayload.userId);\n                }\n\n                // Otherwise update or add\n                const index = current.findIndex(u => u.userId === eventPayload.userId);\n                if (index !== -1) {\n                    const newUsers = [...current];\n                    newUsers[index] = { ...newUsers[index], ...eventPayload };\n                    return newUsers;\n                } else {\n                    return [...current, eventPayload];\n                }\n            });\n        });\n\n        return () => {\n            mounted = false;\n            unsubscribe();\n        };\n    }, [client]);\n\n    return users;\n}\n","import { useEffect, useRef, useCallback } from 'react';\nimport { useNmeshedContext } from './context';\n\nexport type BroadcastHandler = (payload: unknown) => void;\n\n/**\n * Hook to consume and send ephemeral broadcast messages.\n * \n * @param handler - Optional callback for received messages.\n * @returns Function to broadcast messages.\n */\nexport function useBroadcast(handler?: BroadcastHandler) {\n    const client = useNmeshedContext();\n    const handlerRef = useRef(handler);\n\n    // Keep handler ref fresh without re-running effect\n    useEffect(() => {\n        handlerRef.current = handler;\n    }, [handler]);\n\n    useEffect(() => {\n        if (!handlerRef.current) return;\n\n        const unsubscribe = client.onBroadcast((payload) => {\n            if (handlerRef.current) {\n                handlerRef.current(payload);\n            }\n        });\n\n        return () => {\n            unsubscribe();\n        };\n    }, [client]);\n\n    const broadcast = useCallback((payload: unknown) => {\n        client.broadcast(payload);\n    }, [client]);\n\n    return broadcast;\n}\n","import { useState, useEffect, useCallback, useRef } from 'react';\nimport { useBroadcast } from './useBroadcast';\nimport { packCursor, unpackCursor, isBinaryCursor } from '../sync/binary';\n// Note: usePresence is not needed for cursor tracking, only raw broadcast\n\nexport interface CursorState {\n    x: number;\n    y: number;\n    targetX: number;\n    targetY: number;\n    lastUpdate: number;\n    color: string;\n}\n\nconst START_COLORS = ['#f87171', '#fb923c', '#fbbf24', '#a3e635', '#34d399', '#22d3ee', '#818cf8', '#e879f9'];\n\nfunction getColor(id: string) {\n    let hash = 0;\n    for (let i = 0; i < id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);\n    return START_COLORS[Math.abs(hash) % START_COLORS.length];\n}\n\n/**\n * Standard SVG Cursor\n */\nfunction CursorIcon({ color }: { color: string }) {\n    return (\n        <svg\n            className=\"w-5 h-5 drop-shadow-sm\"\n            viewBox=\"0 0 24 24\"\n            fill={color}\n            xmlns=\"http://www.w3.org/2000/svg\"\n        >\n            <path d=\"M5.65376 12.3673H5.46026L5.31717 12.4976L0.500002 16.8829L0.500002 1.19138L11.7841 12.3673H5.65376Z\" />\n        </svg>\n    );\n}\n\n/**\n * A drop-in component that renders live multiplayer cursors.\n * Optimized for 60fps+ by bypassing React render cycle for movement.\n * Uses requestAnimationFrame and direct DOM manipulation.\n */\nexport function LiveCursors({ selfId }: { selfId?: string }) {\n    // 1. Mutable State (No Re-renders for movement)\n    const cursorState = useRef<Record<string, CursorState>>({});\n    const domRefs = useRef<Record<string, HTMLDivElement | null>>({});\n    const requestRef = useRef<number>(0);\n\n    // 2. React State (Only for mounting/unmounting DOM elements)\n    const [activeIds, setActiveIds] = useState<string[]>([]);\n\n    // 3. Game Loop (Animation Frame)\n    const animate = useCallback(() => {\n        const LERP_FACTOR = 0.2; // Smoothness tuning\n\n        for (const id of activeIds) {\n            const cursor = cursorState.current[id];\n            const el = domRefs.current[id];\n\n            if (cursor && el) {\n                // LERP: Current + (Target - Current) * Factor\n                const dx = cursor.targetX - cursor.x;\n                const dy = cursor.targetY - cursor.y;\n\n                // Snap if close to stop micro-jitter\n                if (Math.abs(dx) < 0.1 && Math.abs(dy) < 0.1) {\n                    cursor.x = cursor.targetX;\n                    cursor.y = cursor.targetY;\n                } else {\n                    cursor.x += dx * LERP_FACTOR;\n                    cursor.y += dy * LERP_FACTOR;\n                }\n\n                // Direct DOM update (Zero React Overhead)\n                // Using translate3d forces GPU acceleration layer\n                el.style.transform = `translate3d(${cursor.x}px, ${cursor.y}px, 0)`;\n            }\n        }\n\n        requestRef.current = requestAnimationFrame(animate);\n    }, [activeIds]);\n\n    // Start/Stop Loop\n    useEffect(() => {\n        requestRef.current = requestAnimationFrame(animate);\n        return () => cancelAnimationFrame(requestRef.current);\n    }, [animate]);\n\n    // 4. Handle Incoming Broadcasts\n    const handleBroadcast = useCallback((payload: unknown) => {\n        let x: number, y: number, userId: string;\n\n        // A. Binary Path (Fast)\n        if (isBinaryCursor(payload)) {\n            const decoded = unpackCursor(payload as ArrayBuffer);\n            if (!decoded) return;\n            x = decoded.x;\n            y = decoded.y;\n            userId = decoded.userId;\n        }\n        // B. JSON Path (Legacy/Fallback)\n        else {\n            const data = payload as any;\n            if (data.type !== 'cursor') return;\n            x = data.x;\n            y = data.y;\n            userId = data.userId;\n        }\n\n        if (userId === selfId) return;\n\n        const now = Date.now();\n        if (!cursorState.current[userId]) {\n            // New cursor: Mount\n            cursorState.current[userId] = {\n                x, y, targetX: x, targetY: y,\n                lastUpdate: now,\n                color: getColor(userId),\n            };\n            setActiveIds(prev => [...prev, userId]);\n        } else {\n            // Update\n            const c = cursorState.current[userId];\n            c.targetX = x;\n            c.targetY = y;\n            c.lastUpdate = now;\n        }\n    }, [selfId]);\n\n    const broadcast = useBroadcast(handleBroadcast);\n\n    // 5. Cleanup Stale Cursors\n    useEffect(() => {\n        const interval = setInterval(() => {\n            const now = Date.now();\n            let changed = false;\n\n            Object.entries(cursorState.current).forEach(([id, c]) => {\n                if (now - c.lastUpdate > 5000) { // 5s timeout\n                    delete cursorState.current[id];\n                    delete domRefs.current[id];\n                    changed = true;\n                }\n            });\n\n            if (changed) {\n                setActiveIds(Object.keys(cursorState.current));\n            }\n        }, 1000);\n        return () => clearInterval(interval);\n    }, []);\n\n    // 6. Broadcast My Position (Throttled + Binary)\n    useEffect(() => {\n        let lastSent = 0;\n        const THROTTLE_MS = 30;\n\n        const handleMouseMove = (e: MouseEvent) => {\n            const now = Date.now();\n            if (now - lastSent < THROTTLE_MS) return;\n\n            lastSent = now;\n\n            // Binary Pack!\n            // Note: clientX/Y are relative to viewport.\n            // In a real app we might want pageX/Y or normalized 0..1 coords.\n            // But this matches the JSON behavior for now.\n            if (selfId) {\n                const buffer = packCursor(selfId, e.clientX, e.clientY);\n                broadcast(buffer);\n            }\n        };\n\n        window.addEventListener('mousemove', handleMouseMove);\n        return () => window.removeEventListener('mousemove', handleMouseMove);\n    }, [broadcast, selfId]);\n\n    return (\n        <div className=\"pointer-events-none fixed inset-0 overflow-hidden z-[9999]\">\n            {activeIds.map(id => {\n                const state = cursorState.current[id];\n                if (!state) return null;\n\n                return (\n                    <div\n                        key={id}\n                        ref={el => { domRefs.current[id] = el; }}\n                        className=\"absolute will-change-transform\"\n                        style={{\n                            // Start position, implementation handles the rest\n                            transform: `translate3d(${state.x}px, ${state.y}px, 0)`\n                        }}\n                    >\n                        <CursorIcon color={state.color} />\n                        <div\n                            className=\"ml-2 px-2 py-1 rounded-full text-xs font-semibold text-white shadow-md\"\n                            style={{ backgroundColor: state.color }}\n                        >\n                            {id}\n                        </div>\n                    </div>\n                );\n            })}\n        </div>\n    );\n}\n","import { usePresence } from './usePresence';\n\n/**\n * A horizontal stack of avatars showing online users.\n */\nexport function AvatarStack() {\n    const users = usePresence();\n\n    if (users.length === 0) return null;\n\n    return (\n        <div className=\"flex -space-x-2 overflow-hidden items-center\">\n            {users.map((user) => (\n                <div\n                    key={user.userId}\n                    className=\"inline-block h-8 w-8 rounded-full ring-2 ring-white dark:ring-gray-800 bg-gray-200 flex items-center justify-center text-xs font-medium text-gray-600 relative\"\n                    title={`${user.userId} (${user.status})`}\n                >\n                    {user.userId.slice(0, 2).toUpperCase()}\n                    {user.status === 'online' && (\n                        <span className=\"absolute bottom-0 right-0 block h-2 w-2 rounded-full ring-2 ring-white bg-green-400\" />\n                    )}\n                </div>\n            ))}\n            <div className=\"ml-4 text-xs text-gray-500\">\n                {users.length} active\n            </div>\n        </div>\n    );\n}\n"]}